#include "CommandBlockExploitCommand.h"

#include "../../../SDK/Tag.h"
#include "../../Module/ModuleManager.h"
#include <thread>

CommandBlockExploitCommand::CommandBlockExploitCommand() : IMCCommand("commandblockexploit", "Workaround for executing commands without op", "<command>") {
	registerAlias("cbe");
}

CommandBlockExploitCommand::~CommandBlockExploitCommand() {
}

bool CommandBlockExploitCommand::execute(std::vector<std::string>* args) {
	assertTrue(args->size() > 2);
	std::ostringstream os;
	for (int i = 1; i < args->size(); i++) {
		if (i > 1)
			os << " ";
		os << args->at(i);
	}
	void* ItemPtr = malloc(0x8);
	C_Item*** cStack = ItemRegistry::getItemFromId(ItemPtr, 325);
	C_ItemStack* yot = new C_ItemStack(***cStack, 1, 5);
	free(ItemPtr);
	int slot = g_Data.getLocalPlayer()->getSupplies()->inventory->getFirstEmptySlot();
	std::string cmd = os.str();
	std::string tag = "{ChestItems:[{Count:0b,Damage:0s,Name:\"\",Slot:0b}],Chested:0b,Color:0b,Color2:0b,Command:\"" + cmd + "\",CurrentTickCount:0,ExecuteOnFirstTick:1b,FallDistance:0f,Fire:0s,InventoryVersion:\"1.14.20\",Invulnerable:0b,IsAngry:0b,IsAutonomous:0b,IsBaby:0b,IsEating:0b,IsGliding:0b,IsGlobal:0b,IsIllagerCaptain:0b,IsOrphaned:0b,IsRoaring:0b,IsScared:0b,IsStunned:0b,IsSwimming:0b,IsTamed:0b,IsTrusting:0b,LastDimensionId:0,LastExecution:0l,LootDropped:0b,MarkVariant:0,Motion:[0f,0.1f,0f],OnGround:1b,OwnerNew:-1l,PortalCooldown:0,Pos:[0f,0f,0f],Rotation:[0f,0f],Saddled:0b,Sheared:0b,ShowBottom:0b,Sitting:0b,SkinID:0,Strength:0,StrengthMax:0,SuccessCount:1000,TickDelay:1,Ticking:1b,TrackOutput:1b,UniqueID:0l,Variant:0,Version:10,definitions:[\"+minecraft:command_block_minecart\",\"+minecraft:command_block_inactive\"],identifier:\"minecraft:command_block_minecart\",EntityType:100}";
	yot->setUserData(std::move(Mojangson::parseTag(tag)));
	g_Data.getLocalPlayer()->getTransactionManager()->addInventoryAction(C_InventoryAction(0, yot, nullptr, 507, 99999));
	g_Data.getLocalPlayer()->getTransactionManager()->addInventoryAction(C_InventoryAction(slot, nullptr, yot));
	g_Data.getLocalPlayer()->getSupplies()->inventory->addItemToFirstEmptySlot(yot);
	clientMessageF("[%sHorion%s] %sPlace the bucket to spawn a command block minecart with a command already inside!", GOLD, WHITE, GREEN);
	return true;
}
